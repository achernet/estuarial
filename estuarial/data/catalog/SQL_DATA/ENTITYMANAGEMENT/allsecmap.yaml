SQL:
    equity_master:
        type: conditional
        conditionals:
            - seccode
            - vencode
            - ventype
        query: >
            SELECT map.seccode, map.ventype, map.vencode, map.rank,
                CASE WHEN map.exchange = 1 THEN 'US'
                     WHEN map.exchange = 2 THEN 'CA'
                     ELSE 'N/A'
                     END AS exchange,
                map.startdate, map.enddate, a.minrank
             FROM dbo.SecMapX map
             inner join
                (select min(Rank) as minrank, map.ventype, map.seccode, map.exchange
                    from dbo.secmapx map
                    group by map.seccode, map.ventype, map.exchange) a
                ON map.ventype = a.ventype
                AND map.seccode = a.seccode
                AND map.exchange = a.exchange

            UNION ALL

            SELECT
                    gmap.seccode + 100000000
                ,	gmap.ventype
                ,	gmap.vencode
                ,	gmap.rank
                ,	'G' AS exchange
                ,	gmap.startdate
                ,	gmap.enddate
                ,	b.minrank
             FROM dbo.GSecMapX gmap
             INNER JOIN
                (SELECT min(Rank) AS minrank, gmap.ventype, gmap.seccode, gmap.exchange
                    from dbo.gsecmapx gmap
                    group by gmap.seccode, gmap.ventype, gmap.exchange) b
                ON	gmap.ventype = b.ventype
                AND gmap.seccode = b.seccode
                AND gmap.exchange = b.exchange